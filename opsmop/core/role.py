# Copyright 2018 Michael DeHaan LLC, <michael@michaeldehaan.net>
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from opsmop.core.collection import Collection
from opsmop.core.field import Field
from opsmop.core.fields import Fields
from opsmop.core.handlers import Handlers
from opsmop.core.resource import Resource
from opsmop.core.resources import Resources
from opsmop.callbacks.callbacks import Callbacks
from opsmop.client.user_defaults import UserDefaults

class Role(Collection):

    """
    A role is a collection of resources, handlers, and variables.  A Site policy can
    contain more than one one role.
    
    For an example see demo/content.py
    """

    def __init__(self, *args, **kwargs):
        (original, common) = self.split_common_kwargs(kwargs)
        self.setup(extra_variables=original, **common)

    def fields(self):
        return Fields(
            self,
            name = Field(kind=str, default=None),
            variables = Field(kind=dict, loader=self.set_variables),
            resources = Field(kind=list, of=Resource, loader=self.set_resources),
            handlers  = Field(kind=dict, of=Resource, loader=self.set_handlers),
        )

    def set_variables(self):
        return dict()

    def set_resources(self):
        return Resources()

    def set_handlers(self):
        return Handlers()

    def sudo(self):
        return False

    def ssh_as(self):
        return (UserDefaults.ssh_username(), UserDefaults.ssh_password())

    def sudo_as(self):
        return (UserDefaults.sudo_username(), UserDefaults.sudo_password())

    def check_host_keys(self):
        return UserDefaults.ssh_check_host_keys()

    def _on_walk(self):
        Callbacks.on_role(self)

    def get_children(self, mode):
        if mode == 'resources':
            return self.resources
        elif mode == 'handlers':
            return self.handlers

    def __str__(self):
        return "Role: %s" % self.__class__.__name__
